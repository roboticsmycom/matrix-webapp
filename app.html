<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Игра на Звёзды</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: Arial; display: flex; flex-direction: column; align-items: center; height: 100vh; padding: 10px; box-sizing: border-box; overflow: hidden; }
        #balance { font-size: 20px; position: absolute; top: 10vh; left: 50%; transform: translateX(-50%); text-align: center; white-space: nowrap; }
        #rooms { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; position: absolute; top: 50%; transform: translateY(-50%); width: 80%; justify-items: center; }
        button { background: #4CAF50; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; font-size: 16px; width: 100%; text-align: center; line-height: 1.2; }
        #exit-btn { background: #f44336; position: absolute; bottom: 10vh; left: 50%; transform: translateX(-50%); width: 200px; }
        #move-btn { background: #2196F3; margin-bottom: 10px; }
        #svg-container { width: 90vw; height: 50vh; margin-bottom: 10px; padding-top: 10px; } /* Поле в верхней половине, отступ от верха = padding-left/right (10px) */
        #result { font-size: 18px; margin-bottom: 10px; text-align: center; } /* Результат на отдельной строчке */
        #history { list-style: none; padding: 0; font-size: 14px; }
        #history li { margin-bottom: 5px; }
        .cell { fill: lightgray; border-radius: 2px; }
        .text { font-size: 2px; text-anchor: middle; dominant-baseline: central; fill: black; }
        .win { fill: green; }
        .current-loss { fill: red; animation: pulse 1s ease-in-out; }
        .current-win { fill: gold; animation: glow 1s ease-in-out infinite alternate; }
        @keyframes pulse { 0% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes glow { 0% { fill: gold; } 100% { fill: yellow; } }
        #main-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; position: relative; }
        #main-content { display: flex; flex-direction: column; align-items: center; }
        #room-screen { display: none; text-align: center; flex-direction: column; height: 100vh; position: relative; } /* Верхняя половина для поля, нижняя для элементов */
        #lower-half { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; }
    </style>
</head>
<body>
    <div id="main-screen">
        <div id="balance">Баланс: 1000 ⭐</div>
        <div id="rooms">
            <button onclick="selectRoom(1)">1<br>⭐</button>
            <button onclick="selectRoom(10)">10<br>⭐</button>
            <button onclick="selectRoom(100)">100<br>⭐</button>
            <button onclick="selectRoom(1000)">1000<br>⭐</button>
        </div>
        <button id="exit-btn" onclick="exitApp()">Выход</button>
    </div>
    <div id="room-screen">
        <div id="svg-container"></div> /* Поле в верхней половине, начинается у верха с отступом padding */
        <div id="lower-half">
            <div id="balance">Баланс: 1000 ⭐</div> /* 1) Баланс на отдельной строчке */
            <div id="result"></div> /* 2) Результат +n⭐ или -n⭐ на отдельной строчке */
            <button id="move-btn" onclick="makeMove()">Сделать ход</button> /* 3) Кнопка "Сделать ход" на отдельной строчке */
            <button onclick="leaveRoom()" style="background: #f44336; margin-top: 10px;">Назад</button> /* 4) Кнопка "Назад" на отдельной строчке */
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();  // Полноэкранный режим

        let currentBet = null;
        let balance = 1000;  // Тестовый
        let history = [];
        let currentRow = 1;
        let currentCol = 1;
        let isWin = false;

        function selectRoom(bet) {
            currentBet = bet;
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('room-screen').style.display = 'flex';
            tg.sendData(JSON.stringify({action: 'select_room', bet: bet}));
            renderField(currentRow, currentCol, isWin);
            updateBalance();
        }

        function makeMove() {
            if (balance < currentBet) {
                alert('Недостаточно ⭐!');
                return;
            }
            tg.sendData(JSON.stringify({action: 'make_move', bet: currentBet}));
            // Симуляция последовательного хода
            currentCol += 1;
            if (currentCol > 10) {
                currentCol = 1;
                currentRow += 1;
            }
            if (currentRow > 10) currentRow = 1;
            isWin = currentRow === currentCol;
            const win = isWin ? currentBet * currentRow : 0;
            balance += win - currentBet;
            let message = isWin ? `+ ${win}⭐` : `- ${currentBet} ⭐`;  // Изменённое сообщение
            history.push(message);
            updateBalance();
            updateResult(message);
            updateHistory();
            renderField(currentRow, currentCol, isWin);
        }

        function leaveRoom() {
            currentBet = null;
            document.getElementById('room-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            tg.sendData(JSON.stringify({action: 'leave_room'}));
        }

        function exitApp() {
            tg.close();
        }

        function updateBalance() {
            const balances = document.querySelectorAll('#balance');
            balances.forEach(b => b.textContent = `Баланс: ${balance} ⭐`);
        }

        function updateResult(lastMessage) {
            document.getElementById('result').textContent = lastMessage;
        }

        function updateHistory() {
            const ul = document.getElementById('history');
            ul.innerHTML = '';
            history.slice(-3).forEach(item => {  // Только 3 последних
                const li = document.createElement('li');
                li.textContent = item;
                ul.appendChild(li);
            });
        }

        function renderField(currentRow, currentCol, isWin) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 100 100");
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    let x = j * 10;
                    let y = i * 10;
                    let className = 'cell';
                    if (i === j) className += ' win';
                    if (i === currentRow - 1 && j === currentCol - 1) className += isWin ? ' current-win' : ' current-loss';

                    const rect = document.createElementNS(svgNS, "rect");
                    rect.setAttribute("x", x);
                    rect.setAttribute("y", y);
                    rect.setAttribute("width", 10);
                    rect.setAttribute("height", 10);
                    rect.setAttribute("class", className);
                    svg.appendChild(rect);

                    const text = document.createElementNS(svgNS, "text");
                    text.setAttribute("x", x + 5);
                    text.setAttribute("y", y + 5);
                    text.setAttribute("class", "text");
                    text.textContent = `${i+1}/${j+1}`;
                    svg.appendChild(text);
                }
            }
            const container = document.getElementById('svg-container');
            container.innerHTML = '';
            container.appendChild(svg);
        }
    </script>
</body>
</html>
